@model List<OrderVM>
@{
    // Extract status from query string and set active classes
    var status = Context.Request.Query["status"];
    var pending = "text-primary";
    var inprocess = "text-primary";
    var completed = "text-primary";
    var approved = "text-primary";
    var all = "text-primary";

    switch (status)
    {
        case "pending":
            pending = "active text-white bg-primary";
            break;
        case "inprocess":
            inprocess = "active text-white bg-primary";
            break;
        case "completed":
            completed = "active text-white bg-primary";
            break;
        case "approved":
            approved = "active text-white bg-primary";
            break;
        default:
            all = "active text-white bg-primary";
            break;
    }
}

<div class="container-fluid mt-5 px-3">
    <div class="card shadow rounded-4 border-0">
        <div class="card-body p-4">
            <div class="d-flex justify-content-between align-items-center mb-4 px-3">
                <h2 class="fw-bold text-primary mb-0">📦 Orders Management</h2>
            </div>

            <!-- Status Filter Buttons -->
            <div class="d-flex justify-content-start mb-3 px-2">
                <ul class="list-group list-group-horizontal status-filters">
                    <a style="text-decoration:none;" asp-controller="Order" asp-action="Index" asp-route-status="all">
                    <li class="list-group-item filter-btn @all">ALL</li>
                    </a>
                    <a style="text-decoration:none;" asp-controller="Order" asp-action="Index" asp-route-status="inprocess">
                    <li class="list-group-item filter-btn @inprocess">In Process</li>
                    </a>
                    <a style="text-decoration:none;" asp-controller="Order" asp-action="Index" asp-route-status="pending">
                    <li class="list-group-item filter-btn @pending">Payment Pending</li>
                    </a>
                    <a style="text-decoration:none;" asp-controller="Order" asp-action="Index" asp-route-status="completed">
                    <li class="list-group-item filter-btn @completed">Completed</li>
                    </a>
                    <a style="text-decoration:none;" asp-controller="Order" asp-action="Index" asp-route-status="approved">
                    <li class="list-group-item filter-btn @approved">Approved</li>
                    </a>
                </ul>
            </div>

            <div class="table-responsive" style="max-height: 600px; overflow-y: auto; overflow-x: auto;">
                <table id="tblData" class="table table-striped table-hover align-middle text-center mb-0" style="width:100%; table-layout: fixed;">
                    <thead class="table-primary text-secondary">
                        <tr>
                            <th style="min-width: 80px;">ID</th>
                            <th style="min-width: 120px;">Name</th>
                            <th style="min-width: 120px;">Phone Number</th>
                            <th style="min-width: 150px;">Email</th>
                            <th style="min-width: 100px;">Status</th>
                            <th style="min-width: 80px;">Total</th>
                            <th style="min-width: 100px;">Actions</th>
                        </tr>
                    </thead>
                </table>
            </div>
        </div>
    </div>
</div>

<style>
    #tblData th, #tblData td {
        text-overflow: ellipsis;
        overflow: hidden;
        white-space: nowrap;
    }

    .status-filters {
        padding: 0;
        margin: 0;
        list-style: none;
    }

        .status-filters .filter-btn {
            cursor: pointer;
            margin-right: 10px;
            padding: 8px 16px;
            border-radius: 25px;
            font-weight: 500;
            transition: all 0.3s ease;
            border: 1px solid #ddd;
            background-color: #f8f9fa;
            color: #495057;
        }

            .status-filters .filter-btn:hover {
                background-color: black;
                color: #fff;
                transform: scale(1.05);
            }

            .status-filters .filter-btn.active {
                background-color: black;
                color: #fff;
                font-weight: bold;
                border-color: white;
            }

    .badge {
        font-size: 0.85rem;
        padding: 0.35em 0.65em;
        border-radius: 0.5rem;
        font-weight: 500;
    }
</style>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    function loadDataTable(status) {
        console.log("Loading data for status: " + status);

        if ($.fn.DataTable.isDataTable('#tblData')) {
            $('#tblData').DataTable().destroy();
        }

        $('#tblData').DataTable({
            responsive: true,
            scrollX: true,
            scrollY: "500px",
            scrollCollapse: true,
            autoWidth: false,
            ajax: {
                url: '/Admin/Order/GetAll?status=' + status,
                dataSrc: 'data'
            },
            columns: [
                { data: 'id', width: "80px" },
                { data: 'name', width: "120px" },
                { data: 'phoneNumber', width: "120px" },
                { data: 'applicationUser.email', width: "150px", render: function(data){ return data ? data : ''; } },
                { data: 'orderStatus', width: "100px", render: function(data){ return data ? data : ''; } },
                { data: 'orderTotal', width: "80px" },
                { data: 'id', width: "100px", render: function(data){
                    // Updated to use route parameter matching fixed controller
                    return `<a href="/Admin/Order/Details/${data}" class="btn btn-outline-primary btn-sm rounded-pill px-2" title="View Order">
                                <i class="bi bi-eye"></i> View
                            </a>`;
                }}
            ],
            language: { emptyTable: "No orders available." },
            error: function(xhr, error, thrown) {
                console.log(xhr.responseText);
            }
        });
    }

    $(document).ready(function () {
        // Use URLSearchParams for cleaner status handling
        var params = new URLSearchParams(window.location.search);
        var status = params.get("status") || "all";
        loadDataTable(status);
    });
</script>
